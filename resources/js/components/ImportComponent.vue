<template>
    <section class="content">
        <div class="row">
            <div class="col-12 col-md-6">
                <div class="card-hover-shadow-2x mb-3 card">
                    <div class="card-header-tab card-header">
                        <div
                            class="card-header-title font-size-lg text-capitalize font-weight-normal text-info"
                        >
                            <i class="fas fa-database"></i>Lista Tareas
                        </div>
                    </div>
                    <div class="scroll-area-lg">
                        <section
                            class="ps-container scrollbar-container ps ps--theme_default ps--active-y"
                        >
                            <ul
                                class="todo-list-wrapper list-group list-group-flush"
                            >
                                <li class="list-group-item">
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                            <div class="widget-content-left">
                                                <div
                                                    class="widget-content-left text-olive"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-6 w-6"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                        width="42"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                        />
                                                    </svg>
                                                    nombre archivo.csv
                                                    <div
                                                        class="badge badge-danger ml-2"
                                                    >
                                                        rectificativa
                                                    </div>
                                                </div>
                                                <div class="widget-heading">
                                                    Nombre de organismo
                                                </div>
                                                <div class="text-muted">
                                                    Tipo Liquidación SAC
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-right widget-content-actions"
                                            >
                                                <button
                                                    class="border-0 btn-transition btn btn-outline-info rounded-pill"
                                                >
                                                    Apply</button
                                                ><button
                                                    class="border-0 btn-transition btn btn-outline-danger rounded-pill"
                                                >
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                    width="24"
                                                    class="text-success"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M5 13l4 4L19 7"
                                                    />
                                                </svg>
                                                <span class="text-muted text-xs"
                                                    >hace 15 segundo</span
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="todo-indicator bg-focus"></div>
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                            <div
                                                class="widget-content-left mr-2"
                                            >
                                                <div
                                                    class="custom-checkbox custom-control"
                                                >
                                                    <input
                                                        type="checkbox"
                                                        id="exampleCustomCheckbox1"
                                                        class="custom-control-input"
                                                    /><label
                                                        for="exampleCustomCheckbox1"
                                                        class="custom-control-label"
                                                        >&nbsp;</label
                                                    >
                                                </div>
                                            </div>
                                            <div class="widget-content-left">
                                                <div class="widget-heading">
                                                    Task with hover dropdown
                                                    menu
                                                </div>
                                                <div class="widget-subheading">
                                                    <div>
                                                        By Johnny
                                                        <div
                                                            class="badge badge-pill badge-info ml-2"
                                                        >
                                                            NEW
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-right widget-content-actions"
                                            >
                                                <div class="d-inline-block">
                                                    <div
                                                        class="btn-group b-dropdown dropdown"
                                                        id="__BVID__168"
                                                    >
                                                        <!----><button
                                                            aria-haspopup="true"
                                                            aria-expanded="false"
                                                            type="button"
                                                            class="btn btn-link dropdown-toggle dropdown-toggle-no-caret btn-icon btn-icon-only"
                                                            id="__BVID__168__BV_toggle_"
                                                        >
                                                            <span
                                                                ><i
                                                                    class="pe-7s-menu btn-icon-wrapper"
                                                                ></i
                                                            ></span>
                                                        </button>
                                                        <div
                                                            role="menu"
                                                            tabindex="-1"
                                                            class="dropdown-menu dropdown-menu-right"
                                                            aria-labelledby="__BVID__168__BV_toggle_"
                                                        >
                                                            <ul
                                                                class="nav flex-column"
                                                            >
                                                                <li
                                                                    class="nav-item-header nav-item"
                                                                >
                                                                    Activity
                                                                </li>
                                                                <li
                                                                    class="nav-item"
                                                                >
                                                                    <a
                                                                        href="javascript:void(0);"
                                                                        class="nav-link"
                                                                        >Chat
                                                                        <div
                                                                            class="ml-auto badge badge-pill badge-info"
                                                                        >
                                                                            8
                                                                        </div></a
                                                                    >
                                                                </li>
                                                                <li
                                                                    class="nav-item"
                                                                >
                                                                    <a
                                                                        href="javascript:void(0);"
                                                                        class="nav-link"
                                                                        >Recover
                                                                        Password</a
                                                                    >
                                                                </li>
                                                                <li
                                                                    class="nav-item-header nav-item"
                                                                >
                                                                    My Account
                                                                </li>
                                                                <li
                                                                    class="nav-item"
                                                                >
                                                                    <a
                                                                        href="javascript:void(0);"
                                                                        class="nav-link"
                                                                        >Settings
                                                                        <div
                                                                            class="ml-auto badge badge-success"
                                                                        >
                                                                            New
                                                                        </div></a
                                                                    >
                                                                </li>
                                                                <li
                                                                    class="nav-item"
                                                                >
                                                                    <a
                                                                        href="javascript:void(0);"
                                                                        class="nav-link"
                                                                        >Messages
                                                                        <div
                                                                            class="ml-auto badge badge-warning"
                                                                        >
                                                                            512
                                                                        </div></a
                                                                    >
                                                                </li>
                                                                <li
                                                                    class="nav-item"
                                                                >
                                                                    <a
                                                                        href="javascript:void(0);"
                                                                        class="nav-link"
                                                                        >Logs</a
                                                                    >
                                                                </li>
                                                                <li
                                                                    class="nav-item-divider nav-item"
                                                                ></li>
                                                                <li
                                                                    class="nav-item-btn nav-item"
                                                                >
                                                                    <button
                                                                        class="btn-wide btn-shadow btn btn-danger btn-sm"
                                                                    >
                                                                        Cancel
                                                                    </button>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div
                                        class="todo-indicator bg-primary"
                                    ></div>
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                            <div
                                                class="widget-content-left mr-2"
                                            >
                                                <div
                                                    class="custom-checkbox custom-control"
                                                >
                                                    <input
                                                        type="checkbox"
                                                        id="exampleCustomCheckbox4"
                                                        class="custom-control-input"
                                                    /><label
                                                        for="exampleCustomCheckbox4"
                                                        class="custom-control-label"
                                                        >&nbsp;</label
                                                    >
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-left flex2"
                                            >
                                                <div class="widget-heading">
                                                    Badge on the right task
                                                </div>
                                                <div class="widget-subheading">
                                                    This task has show on hover
                                                    actions!
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-right widget-content-actions"
                                            >
                                                <button
                                                    class="border-0 btn-transition btn btn-outline-success"
                                                >
                                                    <svg
                                                        aria-hidden="true"
                                                        focusable="false"
                                                        data-prefix="fas"
                                                        data-icon="check"
                                                        role="img"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        viewBox="0 0 512 512"
                                                        class="svg-inline--fa fa-check fa-w-16"
                                                    >
                                                        <path
                                                            fill="currentColor"
                                                            d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"
                                                            class=""
                                                        ></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div
                                                class="widget-content-right ml-3"
                                            >
                                                <div
                                                    class="badge badge-pill badge-success"
                                                >
                                                    Latest Task
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="todo-indicator bg-info"></div>
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                            <div
                                                class="widget-content-left mr-2"
                                            >
                                                <div
                                                    class="custom-checkbox custom-control"
                                                >
                                                    <input
                                                        type="checkbox"
                                                        id="exampleCustomCheckbox2"
                                                        class="custom-control-input"
                                                    /><label
                                                        for="exampleCustomCheckbox2"
                                                        class="custom-control-label"
                                                        >&nbsp;</label
                                                    >
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-left mr-3"
                                            >
                                                <div
                                                    class="widget-content-left"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-6 w-6"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                        width="42"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                        />
                                                    </svg>
                                                    nombre archivo.csv
                                                </div>
                                            </div>
                                            <div class="widget-content-left">
                                                <div class="widget-heading">
                                                    Go grocery shopping
                                                </div>
                                                <div class="widget-subheading">
                                                    A short description for this
                                                    todo item
                                                </div>
                                            </div>
                                            <div
                                                class="widget-content-right widget-content-actions"
                                            >
                                                <button
                                                    class="border-0 btn-transition btn btn-outline-success"
                                                >
                                                    <svg
                                                        aria-hidden="true"
                                                        focusable="false"
                                                        data-prefix="fas"
                                                        data-icon="check"
                                                        role="img"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        viewBox="0 0 512 512"
                                                        class="svg-inline--fa fa-check fa-w-16"
                                                    >
                                                        <path
                                                            fill="currentColor"
                                                            d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"
                                                            class=""
                                                        ></path>
                                                    </svg></button
                                                ><button
                                                    class="border-0 btn-transition btn btn-outline-danger"
                                                >
                                                    <svg
                                                        aria-hidden="true"
                                                        focusable="false"
                                                        data-prefix="fas"
                                                        data-icon="trash-alt"
                                                        role="img"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        viewBox="0 0 448 512"
                                                        class="svg-inline--fa fa-trash-alt fa-w-14"
                                                    >
                                                        <path
                                                            fill="currentColor"
                                                            d="M32 464a48 48 0 0 0 48 48h288a48 48 0 0 0 48-48V128H32zm272-256a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zm-96 0a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zm-96 0a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zM432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z"
                                                            class=""
                                                        ></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </section>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="card">
                    <div class="card-header bg-gradient-gray">
                        <h3 class="card-title">Importar Excel \ CSV</h3>

                        <div class="card-tools">
                            <button
                                type="button"
                                class="btn btn-tool"
                                data-card-widget="collapse"
                            >
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <form @submit.prevent="submitFile()">
                        <div class="card-body">
                            <div
                                class="import"
                                style="min-height: 135px; height: 135px; max-height: 135px; max-width: 100%;"
                            >
                                <div class="form-group">
                                    <div class="d-flex align-items-center">
                                        <!-- <label for="file" class="form-label text-muted">Subir Archivo</label> -->
                                        <input
                                            class="form-control border-0"
                                            type="file"
                                            id="file"
                                            name="file"
                                            ref="file"
                                            @change="handleFileUpload()"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <div>
                                <button
                                    type="submit"
                                    name="import"
                                    id="import"
                                    class="btn bg-gradient-gray btn-block"
                                >
                                    <i class="fas fa-file-upload"></i
                                    >&nbsp;Subir
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-12">
                <div class="row" v-if="false">
                    <div class="col">
                        <p>
                            Lorem ipsum dolor, sit amet consectetur adipisicing
                            elit. Blanditiis, excepturi. Sunt deleniti
                            voluptatum obcaecati aspernatur? Et, pariatur odit
                            corrupti amet ratione iure alias, voluptatem culpa
                            provident suscipit, temporibus aperiam aliquid!
                        </p>
                    </div>
                </div>
                <div v-else class="row">
                    <div
                        v-for="(declaracion_jurada,
                        index) in declaraciones_juradas"
                        :key="index"
                        class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column"
                    >
                        <div class="card bg-light d-flex flex-fill">
                            <div class="card-header text-muted border-bottom-0">
                                <nav class="navbar navbar-light bg-light">
                                    <p class="navbar-brand text-muted">
                                        <img
                                            src="/image/logo-ips-header.png"
                                            width="180"
                                            height="40"
                                            alt="ips - logo - Corrientes - institutto de prevision social"
                                        />
                                    </p>
                                </nav>
                            </div>
                            <div class="card-body pt-0">
                                <div class="row">
                                    <div class="col-9">
                                        <h2 class="lead text-sm">
                                            <b>
                                                <i class="fas fa-file-csv"></i>
                                                {{
                                                    declaracion_jurada.nombre_archivo
                                                }}
                                            </b>
                                        </h2>
                                        <p
                                            v-if="declaracion_jurada.rectificar"
                                            class="text-muted text-sm"
                                        >
                                            rectificativa nº
                                            {{
                                                declaraciones_juradas.secuencia
                                            }}
                                        </p>
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="small">
                                                <span class="fa-li"
                                                    ><i
                                                        class="far fa-calendar-alt"
                                                    ></i
                                                ></span>
                                                {{
                                                    declaracion_jurada.periodo
                                                        .periodo
                                                }}
                                            </li>
                                            <li class="small">
                                                <span class="fa-li"
                                                    ><i
                                                        class="fas fa-gopuram"
                                                    ></i
                                                ></span>
                                                {{
                                                    declaracion_jurada.organismo
                                                        .organismo
                                                }}
                                            </li>
                                            <li class="small">
                                                <span class="fa-li"
                                                    ><i
                                                        class="fas fa-file-invoice-dollar"
                                                    ></i
                                                ></span>
                                                Tipo
                                                {{
                                                    declaracion_jurada
                                                        .tipoliquidacion
                                                        .descripcion
                                                }}
                                            </li>
                                            <li class="small">
                                                <span class="fa-li"
                                                    ><i class="far fa-clock"></i
                                                ></span>
                                                {{
                                                    declaracion_jurada.created_at
                                                        | moment
                                                }}
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-3 text-center">
                                        <!-- <button
                                                type="button"
                                                v-if="declaracion_jurada.status"
                                                class="btn btn-outline-info rounded-pill btn-xs btn-block"
                                                @click="
                                                    aplicar(declaracion_jurada)
                                                "
                                                data-toggle="tooltip"
                                                data-placement="top"
                                                title="Aplicar Tarea"
                                            >
                                                <i class="fas fa-tasks"></i>
                                            </button>
                                            <span
                                                v-else
                                                class="badge bg-success rounded-circle"
                                                ><i class="fas fa-check"></i
                                            ></span>
                                            <button
                                                type="button"
                                                class="btn btn-outline-danger rounded-pill btn-xs btn-block"
                                                data-toggle="tooltip"
                                                data-placement="top"
                                                title="Quitar"
                                            >
                                                <i class="fas fa-times"></i>
                                            </button> -->
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="text-right">
                                    <p>
                                        Importado por
                                        <small class="text-muted">{{
                                            declaracion_jurada.user.name
                                        }}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="declaraciones_juradas.length">
                    <span
                        >total registros encontrados: {{ paginate.total }}</span
                    >
                    <paginator-component
                        :data="declaraciones_juradas"
                        :paginate="paginate"
                        @response="asignar(...arguments)"
                    ></paginator-component>
                </div>
            </div>
        </div>
    </section>
</template>

<script>
const Toast = swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 4000,
    timerProgressBar: true,
    didOpen: toast => {
        toast.addEventListener("mouseenter", swal.stopTimer);
        toast.addEventListener("mouseleave", swal.resumeTimer);
    }
});

export default {
    props: ["user"],
    data: function() {
        return {
            file: "",
            declaraciones_juradas: [],
            paginate: {
                current_page: "",
                last_page: "",
                total: "",
                path: "",
                next_page_url: "",
                from: "",
                to: "",
                next_page_url: "",
                prev_page_url: ""
            },
            dd_jj: [],
            declaracion_jurada: {},
            isLoad: false,
            isReciente: false,
            uploadPercentage: 0,
            loadedProgress: 0,
            totalProgress: 0,
            search: ""
        };
    },
    mounted() {
        axios.get("api/archivos-recientes").then(response => {
            if (response.data.length === 0) {
                this.isReciente = false;
            } else {
                this.dd_jj = response.data;
                this.isReciente = true;
            }
        });

        this.getDeclaracionesJudaras();
    },
    methods: {
        // onUploadProgress:function(progressEvent){
        //   this.uploadPercentage = parseInt( Math.round( ( progressEvent.loaded / progressEvent.total ) * 100) );
        // }.bind(this),
        submitFile() {
            let formData = new FormData();
            formData.append("file", this.file);
            formData.append("user_id", this.user.id);

            axios
                .post("api/declaracion_jurada/create", formData, {
                    headers: {
                        "Content-Type": "multipart/form-data"
                    },
                    onUploadProgress: function(progressEvent) {
                        this.loadedProgress = progressEvent.loaded;
                        this.totalProgress = progressEvent.total;
                        this.uploadPercentage = parseInt(
                            Math.round(
                                (progressEvent.loaded / progressEvent.total) *
                                    100
                            )
                        );
                        this.isLoad = true;
                        this.file = "";
                    }.bind(this)
                })
                .then(response => {
                    if (response.data.status) {
                        this.declaracion_jurada = response.data.data;
                        Toast.fire({
                            icon: "success",
                            title:
                                this.declaracion_jurada.nombre_archivo +
                                " se subió con exito",
                            background: "#E7FFD7"
                        });
                        this.dd_jj.unshift(this.declaracion_jurada);
                        this.declaraciones_juradas.unshift(
                            this.declaracion_jurada
                        );
                        this.isReciente = true;
                    } else {
                        if (response.data.confirm) {
                            swal.fire({
                                title:
                                    "Atención! Esta a punto de rectificar, Los cambios seran de forma permanentes.",
                                showCancelButton: true,
                                confirmButtonText: "Save"
                            }).then(result => {
                                if (result.isConfirmed) {
                                    this.rectificar(response.data.data);
                                    // this.declaracion_jurada = response.data.data

                                    // Toast.fire({
                                    //     icon: "success",
                                    //     title:"rectificacion con exitó",
                                    //     background: "#E7FFD7"
                                    // });
                                } else {
                                    window.location.reload();
                                }
                            });
                        } else {
                            Toast.fire({
                                icon: "error",
                                title: response.data.data,
                                background: "#FCDBCD"
                            });
                        }
                    }
                    this.isLoad = false;
                })
                .catch(error => {
                    this.isLoad = false;
                    Toast.fire({
                        icon: "error",
                        title: error.response,
                        background: "#FCDBCD"
                    });
                });
        },
        handleFileUpload() {
            this.file = "";
            this.file = this.$refs.file.files[0];
        },
        getDeclaracionesJudaras() {
            axios.get("api/declaracion_jurada").then(response => {
                this.asignar(response);
            });
        },
        aplicar(declaracion_jurada) {
            $("#" + declaracion_jurada.id)
                .prop("disabled", true)
                .removeClass("btn-outline-warning fas fa-tasks")
                .find("i")
                .removeClass("fas fa-tasks")
                .addClass("btn-outline-info border-0")
                //.append("Cargando <span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span>")
                .append(
                    "<div class='overlay'><i class='fas fa-2x fa-sync-alt fa-spin'></i></div>"
                );
            axios.post("api/import", declaracion_jurada).then(response => {
                this.declaracion_jurada = response.data;
                Toast.fire({
                    icon: "success",
                    title: "importando: " + response.data.nombre_archivo
                });
            });
        },
        rectificar(declaracionjurada) {
            const data = {
                id: declaracionjurada.id,
                user_id: declaracionjurada.user_id,
                secuencia: declaracionjurada.secuencia,
                nombre_archivo: declaracionjurada.nombre_archivo,
                path: declaracionjurada.path,
                status: true,
                rectificar: true
            };

            axios
                .put(`api/declaracion_jurada/update/` + data.id, data)
                .then(response => {
                    this.declaraciones_juradas.unshift(response.data);
                });
        },
        buscar() {
            axios
                .get(`api/declaracion_jurada/buscar/${this.search}`)
                .then(response => {
                    this.declaraciones_juradas = response.data;
                });
        },
        asignar(response) {
            this.declaraciones_juradas = response.data.data;
            this.paginate.current_page = response.data.current_page;
            this.paginate.last_page = response.data.last_page;
            this.paginate.total = response.data.total;
            this.paginate.path = response.data.path;
            this.paginate.from = response.data.from;
            this.paginate.to = response.data.to;
            this.paginate.next_page_url = response.data.next_page_url;
            this.paginate.prev_page_url = response.data.prev_page_url;
        }
    }
};
</script>
